os: osx
language: cpp
compiler: clang
before_install:
  # Fix stupid Homebrew issue with gcc vs oclint
  # https://github.com/travis-ci/travis-ci/issues/8826
  - brew cask uninstall oclint
  # numpy seems to be already installed which interferes with Homebrew
  - pip2 uninstall -y numpy
install:
  # Prevent Homebrew updating itself before each install step
  - export HOMEBREW_NO_AUTO_UPDATE=1
  # Fix limesuite not finding Python installation
  - export CPLUS_INCLUDE_PATH="/usr/local/include"
  # Additional (optional) dependencies
  - brew tap pothosware/pothos
  - brew update
  # This is required because brew fails if a package is already installed but
  # needs an upgrade. Therefore check if it is installed, if so then upgrade,
  # otherwise install package.
  - formulas="cmake pkg-config fftw libiconv libusb libbladerf airspy hackrf ffmpeg librtlsdr nanomsg qt boost opencv limesuite airspyhf";
    for f in $formulas; do
        if brew ls --versions $f >/dev/null; then
            if ! brew outdated $f; then
                brew upgrade $f;
            fi;
        else
            brew install $f;
        fi;
    done
  # This is a "HEAD only" package (installs directly from Git repository)
  - brew install --HEAD libmirisdr
script:
  - mkdir build
  - cd build
  - CMAKE_PREFIX_PATH=/usr/local/opt/qt cmake
        -DCMAKE_C_FLAGS_RELEASE=-DNDEBUG
        -DCMAKE_CXX_FLAGS_RELEASE=-DNDEBUG
        -DCMAKE_INSTALL_PREFIX=$(brew --prefix)
        -DCMAKE_BUILD_TYPE=Release
        -DCMAKE_FIND_FRAMEWORK=LAST
        -DCMAKE_VERBOSE_MAKEFILE=ON
        -Wno-dev
        ..
  - make
  - make install
